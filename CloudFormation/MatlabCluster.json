{
    "AWSTemplateFormatVersion":"2010-09-09",
    "Description":"A simple, scaling Matlab Server built from standard off-the-shelf parts.",
    "Parameters":{
        "MatlabServerAMI":{
            "Description":"Matlab Server AMI",
            "Type":"String",
            "Default":"ami-4716ab2e"
        },
        "MatlabServerPort":{
            "Description":"The TCP port for the Matlab Server",
            "Type":"Number",
            "Default":"8080"
        },
        "MatlabServerInstanceType":{
            "Description":"Matlab Server EC2 instance type",
            "Type":"String",
            "Default":"m1.small",
            "AllowedValues":[
                "t1.micro",
                "m1.small",
                "m1.medium",
                "m1.large",
                "m1.xlarge",
                "m2.xlarge",
                "m2.2xlarge",
                "m2.4xlarge",
                "c1.medium",
                "c1.xlarge",
                "cc1.4xlarge",
                "cc2.8xlarge",
                "cg1.4xlarge"
            ],
            "ConstraintDescription":"must be a valid EC2 instance type."
        },
        "OperatorEmail":{
            "Description":"Email address to notify for scaling operations",
            "Type":"String",
            "Default":"stephen@firstfuel.com"
        },
        "KeyName":{
            "Description":"The EC2 Key Pair to allow SSH access to the instances",
            "Type":"String",
            "Default":"firstfuel-dev-stephen"
        }
    },
    "Resources":{
        "NotificationTopic":{
            "Type":"AWS::SNS::Topic",
            "Properties":{
                "Subscription":[
                    {
                        "Endpoint":{
                            "Ref":"OperatorEmail"
                        },
                        "Protocol":"email"
                    }
                ]
            }
        },
        "MatlabServerGroup":{
            "Type":"AWS::AutoScaling::AutoScalingGroup",
            "Properties":{
                "AvailabilityZones":{
                    "Fn::GetAZs":""
                },
                "LaunchConfigurationName":{
                    "Ref":"MatlabServerLaunchConfig"
                },
                "MinSize":"1",
                "MaxSize":"8",
                "LoadBalancerNames":[
                    {
                        "Ref":"ElasticLoadBalancer"
                    }
                ],
                "NotificationConfiguration":{
                    "TopicARN":{
                        "Ref":"NotificationTopic"
                    },
                    "NotificationTypes":[
                        "autoscaling:EC2_INSTANCE_LAUNCH",
                        "autoscaling:EC2_INSTANCE_LAUNCH_ERROR",
                        "autoscaling:EC2_INSTANCE_TERMINATE",
                        "autoscaling:EC2_INSTANCE_TERMINATE_ERROR"
                    ]
                }
            }
        },
        "MatlabServerLaunchConfig":{
            "Type":"AWS::AutoScaling::LaunchConfiguration",
            "Properties":{
                "KeyName":{
                    "Ref":"KeyName"
                },
                "ImageId":{
                    "Ref":"MatlabServerAMI"
                },
                "SecurityGroups":[
                    {
                        "Ref":"MatlabServerSecurityGroup"
                    }
                ],
                "InstanceType":{
                    "Ref":"MatlabServerInstanceType"
                }
            }
        },
        "MatlabServerScaleUpPolicy":{
            "Type":"AWS::AutoScaling::ScalingPolicy",
            "Properties":{
                "AdjustmentType":"PercentChangeInCapacity",
                "AutoScalingGroupName":{
                    "Ref":"MatlabServerGroup"
                },
                "Cooldown":"180",
                "ScalingAdjustment":"100"
            }
        },
        "MatlabServerScaleDownPolicy":{
            "Type":"AWS::AutoScaling::ScalingPolicy",
            "Properties":{
                "AdjustmentType":"ChangeInCapacity",
                "AutoScalingGroupName":{
                    "Ref":"MatlabServerGroup"
                },
                "Cooldown":"180",
                "ScalingAdjustment":"-1"
            }
        },
        "CPUAlarmHigh":{
            "Type":"AWS::CloudWatch::Alarm",
            "Properties":{
                "AlarmDescription":"Scale-up on high CPU",
                "MetricName":"CPUUtilization",
                "Namespace":"AWS/EC2",
                "Statistic":"Average",
                "Period":"60",
                "EvaluationPeriods":"1",
                "Threshold":"30",
                "AlarmActions":[
                    {
                        "Ref":"MatlabServerScaleUpPolicy"
                    }
                ],
                "Dimensions":[
                    {
                        "Name":"AutoScalingGroupName",
                        "Value":{
                            "Ref":"MatlabServerGroup"
                        }
                    }
                ],
                "ComparisonOperator":"GreaterThanThreshold"
            }
        },
        "CPUAlarmLow":{
            "Type":"AWS::CloudWatch::Alarm",
            "Properties":{
                "AlarmDescription":"Scale-down on low CPU",
                "MetricName":"CPUUtilization",
                "Namespace":"AWS/EC2",
                "Statistic":"Average",
                "Period":"60",
                "EvaluationPeriods":"10",
                "Threshold":"20",
                "AlarmActions":[
                    {
                        "Ref":"MatlabServerScaleDownPolicy"
                    }
                ],
                "Dimensions":[
                    {
                        "Name":"AutoScalingGroupName",
                        "Value":{
                            "Ref":"MatlabServerGroup"
                        }
                    }
                ],
                "ComparisonOperator":"LessThanThreshold"
            }
        },
        "ElasticLoadBalancer":{
            "Type":"AWS::ElasticLoadBalancing::LoadBalancer",
            "Properties":{
                "AvailabilityZones":{
                    "Fn::GetAZs":""
                },
                "Listeners":[
                    {
                        "LoadBalancerPort":"80",
                        "InstancePort":{
                            "Ref":"MatlabServerPort"
                        },
                        "Protocol":"HTTP"
                    }
                ],
                "HealthCheck":{
                    "Target":{
                        "Fn::Join":[
                            "",
                            [
                                "HTTP:",
                                {
                                    "Ref":"MatlabServerPort"
                                },
                                "/mcr/rest/ping"
                            ]
                        ]
                    },
                    "HealthyThreshold":"3",
                    "UnhealthyThreshold":"5",
                    "Interval":"30",
                    "Timeout":"5"
                }
            }
        },
        "MatlabServerSecurityGroup":{
            "Type":"AWS::EC2::SecurityGroup",
            "Properties":{
                "GroupDescription":"Enable SSH access to instances and HTTP on port 8080 from the load balancer only",
                "SecurityGroupIngress":[
                    {
                        "IpProtocol":"tcp",
                        "FromPort":"22",
                        "ToPort":"22",
                        "CidrIp":"0.0.0.0/0"
                    },
                    {
                        "IpProtocol":"tcp",
                        "FromPort":{
                            "Ref":"MatlabServerPort"
                        },
                        "ToPort":{
                            "Ref":"MatlabServerPort"
                        },
                        "SourceSecurityGroupOwnerId":{
                            "Fn::GetAtt":[
                                "ElasticLoadBalancer",
                                "SourceSecurityGroup.OwnerAlias"
                            ]
                        },
                        "SourceSecurityGroupName":{
                            "Fn::GetAtt":[
                                "ElasticLoadBalancer",
                                "SourceSecurityGroup.GroupName"
                            ]
                        }
                    }
                ]
            }
        }
    },
    "Outputs":{
        "URL":{
            "Description":"The URL of the Matlab Server",
            "Value":{
                "Fn::Join":[
                    "",
                    [
                        "http://",
                        {
                            "Fn::GetAtt":[
                                "ElasticLoadBalancer",
                                "DNSName"
                            ]
                        }
                    ]
                ]
            }
        }
    }
}